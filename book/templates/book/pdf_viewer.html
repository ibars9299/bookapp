<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ book.name }} - PDF Görüntüleyici</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --toolbar-height: 60px;
            --sidebar-width: 300px;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
        }
        
        .pdf-container {
            display: flex;
            height: calc(100vh - var(--toolbar-height));
        }
        
        .toolbar {
            height: var(--toolbar-height);
            background: #212529;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .viewer-container {
            flex: 1;
            overflow: hidden;
            background: #f0f0f0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        
        .pages-container {
            display: flex;
            gap: 20px;
            overflow-y: auto;
            padding: 0 20px;
            max-height: 100%;
        }
        
        .page-wrapper {
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 10px;
        }
        
        #pdf-viewer-left, #pdf-viewer-right {
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-left: 1px solid #dee2e6;
            display: none;
            flex-direction: column;
        }
        
        .sidebar.active {
            display: flex;
        }
        
        .notes-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .note-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
        }
        
        .note-input {
            padding: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .toolbar-button {
            background: none;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .toolbar-button:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .page-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        
        #page-input {
            width: 50px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 4px;
            padding: 4px;
        }
        
        /* Scrollbar stilleri */
        .pages-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .pages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .pages-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .pages-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="d-flex align-items-center gap-3">
            <a href="{% url 'index' %}" class="toolbar-button">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h5 class="mb-0">{{ book.name }}</h5>
        </div>
        
        <div class="d-flex align-items-center gap-3">
            <div class="page-info">
                <button class="toolbar-button" id="prev-page">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <input type="number" id="page-input" min="1">
                <span>/ <span id="page-count">0</span></span>
                <button class="toolbar-button" id="next-page">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <button class="toolbar-button" id="zoom-out">
                <i class="fas fa-search-minus"></i>
            </button>
            <button class="toolbar-button" id="zoom-in">
                <i class="fas fa-search-plus"></i>
            </button>
            
            <button class="toolbar-button" id="toggle-notes">
                <i class="fas fa-sticky-note"></i>
            </button>
        </div>
    </div>

    <div class="pdf-container">
        <div class="viewer-container">
            <div class="pages-container">
                <div class="page-wrapper">
                    <canvas id="pdf-viewer-left"></canvas>
                </div>
                <div class="page-wrapper">
                    <canvas id="pdf-viewer-right"></canvas>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="notes-container" id="notes-list">
                <!-- Notlar buraya eklenecek -->
            </div>
            
            <div class="note-input">
                <div class="input-group">
                    <input type="text" class="form-control" id="note-text" placeholder="Not ekle...">
                    <button class="btn btn-dark" id="add-note">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PDF.js'yi yapılandır
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        const bookId = {{ book.id }};
        const userId = {{ user_id }};
        
        // Storage key'lerini kullanıcıya özel hale getirelim
        const storageKeyPrefix = `user_${userId}_book_${bookId}`;
        let pageNum = parseInt(localStorage.getItem(`${storageKeyPrefix}_page`)) || 1;
        let scale = parseFloat(localStorage.getItem(`${storageKeyPrefix}_zoom`)) || 1.5;
        let canvasLeft = document.getElementById('pdf-viewer-left');
        let canvasRight = document.getElementById('pdf-viewer-right');
        let ctxLeft = canvasLeft.getContext('2d');
        let ctxRight = canvasRight.getContext('2d');
        
        // PDF'i yükle
        pdfjsLib.getDocument('{{ book.pdf.url }}').promise.then(function(pdf) {
            pdfDoc = pdf;
            document.getElementById('page-count').textContent = pdf.numPages;
            if (pageNum > pdf.numPages) {
                pageNum = 1;
            }
            document.getElementById('page-input').value = pageNum;
            renderPages(pageNum);
        });

        // Sayfa değiştiğinde localStorage'a kaydet
        function saveCurrentPage(num) {
            localStorage.setItem(`${storageKeyPrefix}_page`, num);
        }

        // İki sayfayı birden render et
        function renderPages(leftPageNum) {
            // Sayfayı kaydet
            saveCurrentPage(leftPageNum);
            
            // Sol sayfa
            pdfDoc.getPage(leftPageNum).then(function(page) {
                let viewport = page.getViewport({scale: scale});
                canvasLeft.height = viewport.height;
                canvasLeft.width = viewport.width;
                
                let renderContext = {
                    canvasContext: ctxLeft,
                    viewport: viewport
                };
                
                page.render(renderContext);
            });

            // Sağ sayfa (varsa)
            if (leftPageNum + 1 <= pdfDoc.numPages) {
                pdfDoc.getPage(leftPageNum + 1).then(function(page) {
                    let viewport = page.getViewport({scale: scale});
                    canvasRight.height = viewport.height;
                    canvasRight.width = viewport.width;
                    
                    let renderContext = {
                        canvasContext: ctxRight,
                        viewport: viewport
                    };
                    
                    page.render(renderContext);
                });
            } else {
                ctxRight.clearRect(0, 0, canvasRight.width, canvasRight.height);
            }
        }

        // Sayfa navigasyonunu güncelle
        document.getElementById('prev-page').addEventListener('click', () => {
            if(pageNum <= 1) return;
            pageNum -= 2;
            if(pageNum < 1) pageNum = 1;
            document.getElementById('page-input').value = pageNum;
            renderPages(pageNum);
        });

        document.getElementById('next-page').addEventListener('click', () => {
            if(pageNum >= pdfDoc.numPages) return;
            pageNum += 2;
            if(pageNum > pdfDoc.numPages) pageNum = pdfDoc.numPages;
            document.getElementById('page-input').value = pageNum;
            renderPages(pageNum);
        });

        // Sayfa numarası girişini güncelle
        document.getElementById('page-input').addEventListener('change', (e) => {
            let num = parseInt(e.target.value);
            if(num >= 1 && num <= pdfDoc.numPages) {
                pageNum = num % 2 === 0 ? num - 1 : num;
                document.getElementById('page-input').value = pageNum;
                renderPages(pageNum);
            }
        });

        // Zoom seviyesini kaydet
        function saveZoomLevel(zoomScale) {
            localStorage.setItem(`${storageKeyPrefix}_zoom`, zoomScale);
        }

        // Zoom kontrollerini güncelle
        document.getElementById('zoom-in').addEventListener('click', () => {
            scale *= 1.2;
            saveZoomLevel(scale);
            renderPages(pageNum);
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            scale *= 0.8;
            saveZoomLevel(scale);
            renderPages(pageNum);
        });

        // Not sistemi için kullanıcıya özel storage key
        const notes = JSON.parse(localStorage.getItem(`${storageKeyPrefix}_notes`) || '[]');
        const notesContainer = document.getElementById('notes-list');
        
        function renderNotes() {
            notesContainer.innerHTML = notes.map((note, index) => `
                <div class="note-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted">Sayfa ${note.page}</small>
                        <button class="btn btn-sm text-danger" onclick="deleteNote(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="mb-0">${note.text}</p>
                    <small class="text-muted">${new Date(note.date).toLocaleString('tr-TR')}</small>
                </div>
            `).join('');
        }

        function addNote(text) {
            notes.push({
                page: pageNum,
                text: text,
                date: new Date().toISOString()
            });
            localStorage.setItem(`${storageKeyPrefix}_notes`, JSON.stringify(notes));
            renderNotes();
        }

        function deleteNote(index) {
            notes.splice(index, 1);
            localStorage.setItem(`${storageKeyPrefix}_notes`, JSON.stringify(notes));
            renderNotes();
        }

        document.getElementById('add-note').addEventListener('click', () => {
            const text = document.getElementById('note-text').value.trim();
            if(text) {
                addNote(text);
                document.getElementById('note-text').value = '';
            }
        });

        document.getElementById('toggle-notes').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('active');
        });

        // İlk yüklemede notları göster
        renderNotes();
    </script>
</body>
</html> 